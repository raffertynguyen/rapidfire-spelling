<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rapid Fire Spelling</title>
    
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='%23f59e0b' stroke='%23f59e0b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><polygon points='13 2 3 14 12 14 11 22 21 10 12 10 13 2'/></svg>" />

    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { 
            font-family: 'Inter', sans-serif; 
            overscroll-behavior-y: contain; 
        }
        
        @keyframes flashRed {
            0% { background-color: #fee2e2; border-color: #ef4444; color: #991b1b; }
            100% { background-color: #f8fafc; border-color: #e2e8f0; color: #1e293b; }
        }
        .error-flash { animation: flashRed 0.4s ease-out; }
    </style>

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</head>
<body class="bg-slate-100 min-h-screen flex flex-col items-center justify-start sm:justify-center p-4">
    <div id="root" class="w-full max-w-md"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const Zap = ({ size, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon></svg>;
        const Play = ({ size, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 3 19 12 5 21 5 3"></polygon></svg>;
        const CheckCircle2 = ({ size, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><path d="m9 12 2 2 4-4"></path></svg>;
        const RotateCcw = ({ size, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"></path><path d="M3 3v5h5"></path></svg>;
        const Eye = ({ size, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M2 12s3-7 10-7 10 7 10 7-3 7-10 7-10-7-10-7Z"></path><circle cx="12" cy="12" r="3"></circle></svg>;
        const SkipForward = ({ size, className }) => <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="5 4 15 12 5 20 5 4"></polygon><line x1="19" y1="5" x2="19" y2="19"></line></svg>;

        const COLORS = {
          main: '#f59e0b', 
          light: '#fef3c7' 
        };

        // CẬP NHẬT: Tách label để ép xuống dòng cho phần trong ngoặc
        const RAPID_MODES = [
          { id: 'letters', main: 'Chữ cái', sub: '(A-Z)' },
          { id: 'numbers', main: 'Số', sub: '(0-9999)' },
          { id: 'mixed', main: 'Kết hợp', sub: '(Chữ & Số)' }
        ];

        function App() {
          const [appState, setAppState] = useState('setup'); 
          const [questionMode, setQuestionMode] = useState('10'); 
          const [customNum, setCustomNum] = useState(20);
          const [rapidCategory, setRapidCategory] = useState('mixed');
          const [isInfinite, setIsInfinite] = useState(false);
          
          const [questions, setQuestions] = useState([]);
          const [currentIndex, setCurrentIndex] = useState(0);
          
          const [userInput, setUserInput] = useState('');
          const [isCorrect, setIsCorrect] = useState(false);
          const [isErrorFlash, setIsErrorFlash] = useState(false);
          const [isAnswerRevealed, setIsAnswerRevealed] = useState(false);
          const [showStopModal, setShowStopModal] = useState(false);
          
          const inputRef = useRef(null);

          const [availableVoices, setAvailableVoices] = useState([]);
          useEffect(() => {
              const loadVoices = () => setAvailableVoices(window.speechSynthesis.getVoices());
              loadVoices(); 
              if (window.speechSynthesis.onvoiceschanged !== undefined) {
                  window.speechSynthesis.onvoiceschanged = loadVoices; 
              }
          }, []);

          const generateRapidItems = (count, category) => {
            let items = [];
            const letters = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
            for(let i = 0; i < count; i++) {
               let isNum = category === 'numbers' ? true : (category === 'letters' ? false : Math.random() > 0.5);
               
               if(!isNum) {
                  const l = letters[Math.floor(Math.random() * letters.length)];
                  items.push({ answer: l, spoken: l, type: 'Letter' });
               } else {
                  const r = Math.random();
                  let digits = 1;
                  if(r < 0.20) digits = 1;
                  else if(r < 0.70) digits = 2; 
                  else if(r < 0.90) digits = 3; 
                  else digits = 4;              

                  let numStr = "";
                  for(let d = 0; d < digits; d++) {
                      if (d === 0) {
                          numStr += Math.floor(Math.random() * 9) + 1; 
                      } else {
                          numStr += Math.floor(Math.random() * 10); 
                      }
                  }
                  items.push({ answer: numStr, spoken: numStr, type: `${digits} Digits` });
               }
            }
            return items;
          };

          // CẬP NHẬT: Tự động Random giọng Nam/Nữ/Kiểu giọng tiếng Anh
          const speakText = (text) => {
            window.speechSynthesis.cancel(); 
            const msg = new SpeechSynthesisUtterance(text);
            
            // Ưu tiên gom các giọng Anh-Anh hoặc Anh-Mỹ
            let enVoices = availableVoices.filter(v => v.lang === 'en-GB' || v.lang === 'en_GB');
            if (enVoices.length === 0) {
                enVoices = availableVoices.filter(v => v.lang.startsWith('en')); // Fallback mọi giọng tiếng Anh
            }
            
            if (enVoices.length > 0) {
                // Bốc ngẫu nhiên 1 giọng trong danh sách để tạo độ linh hoạt
                const randomVoice = enVoices[Math.floor(Math.random() * enVoices.length)];
                msg.voice = randomVoice;
            }
            
            msg.lang = 'en-GB'; 
            msg.rate = 1.0; 
            window.speechSynthesis.speak(msg);
          };

          const startGame = () => {
            let count = parseInt(questionMode);
            if (questionMode === 'custom') count = customNum;
            if (questionMode === 'infinite') { count = 50; setIsInfinite(true); } 
            else setIsInfinite(false);

            setCurrentIndex(0);
            setUserInput('');
            setIsCorrect(false);
            setIsErrorFlash(false);
            setIsAnswerRevealed(false);
            setShowStopModal(false);

            const initialData = generateRapidItems(count, rapidCategory);
            setQuestions(initialData);
            setAppState('playing');
            
            setTimeout(() => {
                inputRef.current?.focus();
                speakText(initialData[0].spoken);
            }, 300);
          };

          useEffect(() => {
            if (appState !== 'playing' || !questions[currentIndex] || isCorrect) return;
            
            const currentInput = userInput.trim().toLowerCase();
            if (currentInput === '') return;

            const ans = questions[currentIndex].answer.toLowerCase();
            
            if (currentInput.length === ans.length) {
               if (currentInput === ans) {
                  setIsCorrect(true);
                  setTimeout(() => {
                     handleNext();
                  }, 200); 
               } else {
                  setIsErrorFlash(true);
                  setTimeout(() => {
                     setUserInput('');
                     setIsErrorFlash(false);
                     speakText(questions[currentIndex].spoken);
                  }, 300);
               }
            }
          }, [userInput]);

          const handleNext = () => {
             const nextIndex = currentIndex + 1;
             if (nextIndex < questions.length) {
                 setCurrentIndex(nextIndex);
                 setUserInput('');
                 setIsCorrect(false);
                 setIsAnswerRevealed(false);
                 speakText(questions[nextIndex].spoken);
                 
                 if (isInfinite && nextIndex >= questions.length - 10) {
                     setQuestions(prev => [...prev, ...generateRapidItems(50, rapidCategory)]);
                 }
             } else {
                 if(isInfinite) {
                    setQuestions(prev => [...prev, ...generateRapidItems(50, rapidCategory)]);
                 } else {
                    setAppState('finished');
                 }
             }
          };

          // CẬP NHẬT: Tự động đóng bàn phím khi ấn Dừng
          const stopGame = () => {
            setShowStopModal(true);
            window.speechSynthesis.cancel();
            inputRef.current?.blur(); // Tước quyền focus để ẩn bàn phím ảo
          };

          const confirmStop = () => {
             setShowStopModal(false);
             setAppState('setup'); 
             window.speechSynthesis.cancel();
          };

          const handleBlur = (e) => {
              if (appState === 'playing' && !showStopModal) {
                  setTimeout(() => inputRef.current?.focus(), 10);
              }
          };

          return (
            <div className="w-full bg-white rounded-3xl shadow-xl border border-slate-100 overflow-hidden relative transition-all duration-300">
                {/* --- MÀN HÌNH SETUP --- */}
                {appState === 'setup' && (
                  <div className="p-6 sm:p-8">
                    <div className="text-center mb-8">
                      <h1 className="text-2xl sm:text-3xl font-extrabold flex items-center justify-center gap-2 text-amber-500">
                        <Zap size={28} /> RAPID FIRE
                      </h1>
                      <p className="text-slate-500 text-sm mt-1">Luyện phản xạ IELTS tốc độ cao</p>
                    </div>

                    <div className="mb-6">
                      <h2 className="text-base font-bold mb-3 text-slate-800">1. Chọn nội dung</h2>
                      <div className="grid grid-cols-3 gap-2">
                        {/* CẬP NHẬT: Chia nhỏ Tiêu đề và Subtitle xuống dòng */}
                        {RAPID_MODES.map(mod => (
                          <label key={mod.id} className={`flex flex-col items-center justify-center p-3 rounded-xl cursor-pointer border-2 transition-all text-xs sm:text-sm text-center leading-tight ${
                            rapidCategory === mod.id ? 'border-amber-500 bg-amber-50 text-amber-600' : 'border-slate-200 bg-slate-50 text-slate-500'
                          }`}>
                            <input type="radio" className="hidden" checked={rapidCategory === mod.id} onChange={() => setRapidCategory(mod.id)} />
                            <span className="font-bold">{mod.main}</span>
                            <span className="font-medium text-[10px] sm:text-xs opacity-80 mt-0.5">{mod.sub}</span>
                          </label>
                        ))}
                      </div>
                    </div>

                    <div className="mb-8">
                      <h2 className="text-base font-bold mb-3 text-slate-800">2. Số lượng</h2>
                      <div className="grid grid-cols-4 gap-2">
                        {[{ id: '10', label: '10' }, { id: '30', label: '30' }, { id: 'custom', label: 'Nhập' }, { id: 'infinite', label: '∞' }].map(opt => (
                          <label key={opt.id} className={`flex items-center justify-center py-3 rounded-xl cursor-pointer border-2 font-bold text-sm transition-all ${
                            questionMode === opt.id ? 'border-amber-500 bg-amber-50 text-amber-600' : 'border-slate-200 bg-slate-50 text-slate-500'
                          }`}>
                            <input type="radio" className="hidden" checked={questionMode === opt.id} onChange={() => setQuestionMode(opt.id)} />
                            {opt.label}
                          </label>
                        ))}
                      </div>
                      {questionMode === 'custom' && (
                        <input type="number" min="1" max="500" value={customNum} onChange={(e) => setCustomNum(parseInt(e.target.value) || 1)}
                          className="mt-3 w-full px-4 py-3 border-2 border-amber-500 bg-amber-50 text-amber-600 rounded-xl font-bold text-center outline-none" placeholder="Nhập số lượng..."
                        />
                      )}
                    </div>

                    <button onClick={startGame} className="w-full py-4 rounded-xl text-white font-bold text-lg hover:shadow-lg transition-all active:scale-95 bg-amber-500">
                      BẮT ĐẦU NGAY
                    </button>
                  </div>
                )}

                {/* --- MÀN HÌNH CHƠI --- */}
                {appState === 'playing' && (
                  <div className="p-6 flex flex-col items-center">
                    
                    <div className="w-full flex items-center justify-between mb-6">
                      <span className="text-sm font-bold tracking-wider px-3 py-1 rounded-lg text-amber-600 bg-amber-50">
                        Câu {currentIndex + 1} {isInfinite ? '' : `/ ${questions.length}`}
                      </span>
                      <button onClick={stopGame} className="text-xs font-bold text-red-500 bg-red-50 px-3 py-2 rounded-lg active:scale-95">
                        DỪNG
                      </button>
                    </div>

                    <div className="mb-8 relative">
                       <button 
                         onMouseDown={(e) => e.preventDefault()} 
                         onClick={() => { speakText(questions[currentIndex].spoken); }} 
                         disabled={isCorrect || isErrorFlash}
                         className={`w-24 h-24 rounded-full flex items-center justify-center text-white shadow-lg transition-all ${(isCorrect || isErrorFlash) ? 'opacity-50 scale-95' : 'active:scale-90 hover:scale-105'}`}
                         style={{ backgroundColor: (isCorrect || isErrorFlash) ? '#cbd5e1' : COLORS.main }}
                       >
                         <Play size={40} className="ml-2" />
                       </button>
                    </div>

                    <div className="h-6 mb-2 w-full flex justify-center items-center text-sm">
                       {isCorrect && <span className="text-emerald-600 font-bold flex items-center gap-1"><CheckCircle2 size={16}/> Chuẩn!</span>}
                       {isErrorFlash && <span className="text-red-500 font-bold">Sai rồi! Nghe lại...</span>}
                    </div>

                    <div className="w-full relative">
                      
                      {!userInput && (
                        <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                          <span className="text-xl font-medium text-slate-400">Nhập...</span>
                        </div>
                      )}

                      <input
                        ref={inputRef} type="text" value={userInput}
                        onChange={(e) => {
                            if (isCorrect || isErrorFlash) return; 
                            setUserInput(e.target.value);
                        }} 
                        onBlur={handleBlur} 
                        inputMode={rapidCategory === 'numbers' ? 'numeric' : 'text'} 
                        autoComplete="off" autoCorrect="off" spellCheck="false" autoCapitalize="characters"
                        className={`w-full text-center text-4xl sm:text-5xl font-extrabold p-6 rounded-2xl outline-none transition-all tracking-widest ${
                          isCorrect ? 'bg-emerald-50 text-emerald-600 border-2 border-emerald-400' 
                          : isErrorFlash ? 'error-flash border-2'
                          : 'bg-slate-50 text-slate-800 border-2 border-slate-200 focus:bg-white focus:border-amber-500 focus:shadow-[0_0_0_4px_#fef3c7]'
                        }`}
                      />

                      {isAnswerRevealed && !isCorrect && (
                        <div className="w-full mt-4 text-center bg-white border border-slate-200 shadow-sm p-4 rounded-xl animate-in fade-in duration-200">
                          <span className="text-sm font-medium text-slate-500 mr-2">Đáp án:</span>
                          <span className="text-xl font-extrabold text-amber-600 tracking-widest bg-amber-50 px-3 py-1 rounded-lg">
                            {questions[currentIndex].answer}
                          </span>
                        </div>
                      )}
                    </div>

                    <div className="flex items-center gap-3 mt-6 w-full max-w-sm">
                      <button 
                        onMouseDown={(e) => e.preventDefault()} 
                        onClick={() => setIsAnswerRevealed(true)} 
                        disabled={isCorrect || isAnswerRevealed} 
                        className="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-semibold text-sm transition-colors bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm active:scale-95"
                      >
                        <Eye size={18} /> Xem đáp án
                      </button>
                      <button 
                        onMouseDown={(e) => e.preventDefault()} 
                        onClick={handleNext} 
                        disabled={isCorrect} 
                        className="flex-1 flex items-center justify-center gap-2 py-3 rounded-xl font-semibold text-sm transition-colors bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 disabled:opacity-50 disabled:cursor-not-allowed shadow-sm active:scale-95"
                      >
                        Bỏ qua <SkipForward size={18} />
                      </button>
                    </div>

                    {showStopModal && (
                      <div className="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-50 flex items-center justify-center p-4">
                        <div className="bg-white rounded-3xl p-6 w-full max-w-xs shadow-2xl text-center">
                          <h3 className="text-xl font-bold text-slate-800 mb-2">Thoát bài tập?</h3>
                          <div className="flex gap-2 mt-6">
                            <button onClick={() => {setShowStopModal(false); setTimeout(() => inputRef.current?.focus(), 100);}} className="flex-1 py-3 rounded-xl font-bold bg-slate-100 text-slate-600">Tiếp tục</button>
                            <button onClick={confirmStop} className="flex-1 py-3 rounded-xl font-bold bg-red-500 text-white">Thoát</button>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                )}

                {/* --- MÀN HÌNH KẾT THÚC --- */}
                {appState === 'finished' && (
                  <div className="p-10 text-center flex flex-col items-center">
                    <div className="w-20 h-20 rounded-full flex items-center justify-center mb-4 bg-emerald-50 text-emerald-500">
                      <CheckCircle2 size={40} />
                    </div>
                    <h2 className="text-2xl font-extrabold mb-2 text-slate-800">Hoàn thành!</h2>
                    <p className="text-slate-500 font-medium mb-8">Bạn đã phản xạ đúng {currentIndex + (isCorrect ? 1 : 0)} câu.</p>
                    <button onClick={() => setAppState('setup')} className="flex items-center justify-center gap-2 w-full py-4 rounded-xl text-white font-bold bg-amber-500 active:scale-95 transition-transform">
                      <RotateCcw size={20} /> Chơi lại
                    </button>
                  </div>
                )}
            </div>
          );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
